{% extends 'layouts/admin_base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block header_title %}<h1><i class="fas fa-gauge"></i> Overview</h1>{% endblock %}
{% block content %}
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon blue"><i class="fas fa-book"></i></div>
    <div class="stat-content"><h3 class="stat-value">{{ total_books }}</h3><p class="stat-label">Books</p></div>
  </div>
  <div class="stat-card">
    <div class="stat-icon purple"><i class="fas fa-users"></i></div>
    <div class="stat-content"><h3 class="stat-value">{{ total_users }}</h3><p class="stat-label">Users</p></div>
  </div>
  <div class="stat-card">
    <div class="stat-icon green"><i class="fas fa-bookmark"></i></div>
    <div class="stat-content"><h3 class="stat-value">{{ total_issued }}</h3><p class="stat-label">Active Issues</p></div>
  </div>
  <div class="stat-card">
    <div class="stat-icon yellow"><i class="fas fa-exclamation-triangle"></i></div>
    <div class="stat-content"><h3 class="stat-value">{{ overdue_count }}</h3><p class="stat-label">Overdue</p></div>
  </div>
</div>

<!-- Pending Book Requests Section -->
<div class="dashboard-card" style="margin-bottom: 1.5rem;">
  <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
    <h2 class="card-title" style="color: white;">
      <i class="fas fa-hourglass-half"></i> Pending Book Requests 
      <span class="badge" style="background: white; color: #f59e0b; padding: 4px 12px; border-radius: 12px; font-size: 0.9rem; margin-left: 8px;">
        {{ pending_requests|length }}
      </span>
    </h2>
  </div>
  <div class="card-body">
    {% if pending_requests %}
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Book</th>
              <th>Requested On</th>
              <th>Due Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in pending_requests %}
              <tr class="table-row">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="activity-icon add" style="width: 32px; height: 32px; min-width: 32px;">
                      <i class="fas fa-user"></i>
                    </div>
                    <strong>{{ issue.user.username }}</strong>
                  </div>
                </td>
                <td>
                  <strong>{{ issue.book.title }}</strong><br>
                  <small style="color: #6b7280;">by {{ issue.book.author }}</small>
                </td>
                <td>{{ issue.issue_date|date:"M d, Y H:i" }}</td>
                <td>{{ issue.return_date|date:"M d, Y" }}</td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    <form method="post" action="{% url 'approve_issue' issue.id %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-check"></i> Approve
                      </button>
                    </form>
                    <form method="post" action="{% url 'reject_issue' issue.id %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger">
                        <i class="fas fa-times"></i> Reject
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981;"></i>
        <p>No pending requests. All caught up! ðŸŽ‰</p>
      </div>
    {% endif %}
  </div>
</div>

<div class="dashboard-grid">
  <div class="dashboard-card">
    <div class="card-header"><h2 class="card-title"><i class="fas fa-clock"></i> Recent Issues</h2></div>
    <div class="card-body">
      <div class="activity-list">
        {% for issue in recent_issues %}
          <div class="activity-item">
            <div class="activity-icon add"><i class="fas fa-book"></i></div>
            <div class="activity-content">
              <p class="activity-text">
                <strong>{{ issue.user.username }}</strong> issued <em>{{ issue.book.title }}</em>
                {% if issue.status == 'requested' %}
                  <span class="badge badge-warning" style="margin-left: 8px;">Pending Approval</span>
                {% elif issue.status == 'approved' or issue.status == 'active' %}
                  <span class="badge badge-success" style="margin-left: 8px;">Approved</span>
                {% elif issue.status == 'rejected' %}
                  <span class="badge badge-danger" style="margin-left: 8px;">Rejected</span>
                {% elif issue.status == 'returned' %}
                  <span class="badge badge-info" style="margin-left: 8px;">Returned</span>
                {% endif %}
              </p>
              <span class="activity-time">{{ issue.issue_date|date:"M d, H:i" }}</span>
              {% if issue.status == 'requested' %}
                <div style="margin-top: 8px; display: flex; gap: 8px;">
                  <form method="post" action="{% url 'approve_issue' issue.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success" style="padding: 4px 12px;">
                      <i class="fas fa-check"></i> Approve
                    </button>
                  </form>
                  <form method="post" action="{% url 'reject_issue' issue.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" style="padding: 4px 12px;">
                      <i class="fas fa-times"></i> Reject
                    </button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="empty-state"><i class="fas fa-inbox"></i><p>No issues yet</p></div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="dashboard-card">
    <div class="card-header"><h2 class="card-title"><i class="fas fa-bolt"></i> Quick Actions</h2></div>
    <div class="card-body">
      <div class="quick-actions">
        <form method="post" action="{% url 'add_book' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="title" value="Sample Book">
          <input type="hidden" name="author" value="Auto Author">
          <input type="hidden" name="isbn" value="AUTO{{ total_books }}">
          <input type="hidden" name="category" value="{% firstof categories.0.id 1 %}">
          <input type="hidden" name="quantity" value="5">
          <input type="hidden" name="price" value="199.00">
          <input type="hidden" name="publication_date" value="2025-01-01">
          <button class="action-btn" type="submit">
            <div class="action-icon blue"><i class="fas fa-plus"></i></div>
            <span>Add Sample Book</span>
          </button>
        </form>
        <a href="{% url 'export_books_csv' %}" class="action-btn">
          <div class="action-icon green"><i class="fas fa-download"></i></div>
          <span>Export Books</span>
        </a>
        <a href="{% url 'export_issues_csv' %}" class="action-btn">
          <div class="action-icon purple"><i class="fas fa-file-csv"></i></div>
          <span>Export Issues</span>
        </a>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock %}
